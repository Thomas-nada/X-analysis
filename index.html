<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IntersectMBO - Interactive Account Analytics Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
            onerror="console.error('CRITICAL ERROR: Failed to load html2canvas script. PNG generation will not work.'); if(document.getElementById('uploadStatus')) { document.getElementById('uploadStatus').textContent = 'Error: Failed to load image capture library.'; document.getElementById('uploadStatus').style.color = 'red'; }">
    </script>
    <!-- Poppins Font Import -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Base styles */
        body {
            font-family: 'Poppins', sans-serif; 
            transition: background-color 0.3s, color 0.3s;
        }

        /* Color Palette from images */
        :root {
            --intersect-blue: #2952E4;
            --intersect-orange: #F97F28;
            --intersect-yellow: #FFC72F; 
            --intersect-cream: #F0EBE0;
            --intersect-dark-bg: #1a202c; 
            --intersect-dark-card: #2d3748;
            --intersect-light-text: #f7fafc;
            --intersect-dark-text: #1f2937;
        }


        /* Light Mode (default) */
        .light-mode {
            background-color: var(--intersect-cream); 
            color: var(--intersect-dark-text); 
        }
        .light-mode .report-section, 
        .light-mode .metric-card, 
        .light-mode .post-card,
        .light-mode .table-container,
        .light-mode .upload-section {
            background-color: #ffffff; 
            color: var(--intersect-dark-text);
        }
        .light-mode .table-header th {
            background-color: #e2e8f0; 
            color: #4a5568;
        }
         .light-mode .section-title-wrapper .section-title {
            color: var(--intersect-blue); 
            border-bottom-color: var(--intersect-blue); 
        }
        .light-mode .text-main-header { color: var(--intersect-blue); } 
        .light-mode .text-sub-header { color: #4a5568; } 
        .light-mode .text-muted { color: #718096; } 
        .light-mode .table-container tbody tr:nth-child(even) {
            background-color: #f7fafc; 
        }
        .light-mode .table-container tbody tr:nth-child(odd) {
            background-color: #ffffff;
        }
        .light-mode .file-input-label {
            background-color: var(--intersect-blue); color: white;
        }
        .light-mode .file-input-label:hover {
            background-color: #1c3fb5; 
        }
        .light-mode .load-button { 
            background-color: #38a169; color: white; 
        }
        .light-mode .load-button:hover {
            background-color: #2f855a;
        }
        .light-mode .slideshow-button { 
             background-color: var(--intersect-orange); color: white;
        }
        .light-mode .slideshow-button:hover {
            background-color: #dd6b20; 
        }
        .light-mode .download-png-button {
            background-color: var(--intersect-blue); color: white; 
            opacity: 0.8;
        }
        .light-mode .download-png-button:hover {
            opacity: 1;
            background-color: #1c3fb5;
        }
        .light-mode select {
            background-color: white;
            border-color: #cbd5e0; 
            color: var(--intersect-dark-text);
        }
        .light-mode .company-logo { 
            filter: invert(1);
        }


        /* Dark Mode */
        .dark-mode {
            background-color: var(--intersect-dark-bg); 
            color: var(--intersect-light-text); 
        }
        .dark-mode .report-section,
        .dark-mode .metric-card,
        .dark-mode .post-card,
        .dark-mode .table-container,
        .dark-mode .upload-section {
            background-color: var(--intersect-dark-card); 
            color: var(--intersect-light-text);
            border-color: #4a5568;
        }
        .dark-mode .table-header th {
            background-color: #4a5568; 
            color: #e2e8f0;
        }
        .dark-mode .section-title-wrapper .section-title {
            color: var(--intersect-blue); 
            border-bottom-color: var(--intersect-blue); 
        }
        .dark-mode .text-main-header { color: var(--intersect-blue); } 
        .dark-mode .text-sub-header { color: #a0aec0; } 
        .dark-mode .text-muted { color: #cbd5e0; } 
        .dark-mode .table-container tbody tr {
            border-color: #4a5568;
        }
        .dark-mode .table-container tbody tr:nth-child(even) {
            background-color: #2d3748; 
        }
        .dark-mode .table-container tbody tr:nth-child(odd) {
            background-color: #354154; 
        }
        .dark-mode .post-card:hover { 
            border-color: var(--intersect-orange);
        }
         .dark-mode .list-item::before {
            color: var(--intersect-blue); 
        }
        .dark-mode .theme-toggle-button { 
            background-color: var(--intersect-orange);
            color: white;
        }
        .dark-mode .theme-toggle-button:hover {
            background-color: #dd6b20;
        }
        .dark-mode .file-input-label {
            background-color: var(--intersect-blue); color: white;
        }
        .dark-mode .file-input-label:hover {
            background-color: #1c3fb5;
        }
        .dark-mode .load-button { 
            background-color: #48bb78; color: var(--intersect-dark-bg);
        }
        .dark-mode .load-button:hover {
            background-color: #38a169;
        }
        .dark-mode .slideshow-button { 
             background-color: var(--intersect-orange); color: white;
        }
        .dark-mode .slideshow-button:hover {
            background-color: #dd6b20;
        }
        .dark-mode .download-png-button {
            background-color: var(--intersect-blue); color: white;
            opacity: 0.9;
        }
        .dark-mode .download-png-button:hover {
            opacity: 1;
            background-color: #1c3fb5;
        }
        .dark-mode select {
            background-color: #4a5568; 
            border-color: #718096; 
            color: var(--intersect-light-text);
        }
        .dark-mode .company-logo { 
            filter: none;
        }


        /* Card styles */
        .report-section, .metric-card, .post-card-wrapper, .table-container, .upload-section { 
            border-radius: 0.75rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out, border-color 0.2s ease-in-out;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .metric-card { padding: 1.5rem; }
        .light-mode .metric-card:hover, .light-mode .post-card-link:hover .post-card { 
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(41, 82, 228, 0.2), 0 4px 6px -2px rgba(41, 82, 228, 0.1); 
        }
        .dark-mode .metric-card:hover, .dark-mode .post-card-link:hover .post-card { 
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(249, 127, 40, 0.3), 0 4px 6px -2px rgba(249, 127, 40, 0.15); 
        }
        .metric-value { font-size: 2rem; font-weight: 700; }
        .light-mode .metric-value { color: var(--intersect-blue); }
        .dark-mode .metric-value { color: var(--intersect-orange); }

        .metric-label { font-size: 0.875rem; }
        .post-card { 
            overflow: hidden; border: 2px solid transparent; display: flex; 
            flex-direction: column; padding: 1.5rem; height: 100%; 
        }
        .post-card-link { display: block; text-decoration: none; border-radius: 0.75rem; }
        .post-card-link .post-card { transition: border-color 0.2s ease-in-out; }
        .light-mode .post-card-link:hover .post-card { border-color: var(--intersect-blue); }
        .dark-mode .post-card-link:hover .post-card { border-color: var(--intersect-orange); }
        .post-card-wrapper .post-card { background-color: inherit; color: inherit;}

        /* Table styles */
        .table-header th { cursor: pointer; position: relative; padding-right: 1.5rem; font-weight: 600;}
        .table-header th .sort-icon { position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); font-size: 0.8em; }
        .table-container { overflow-x: auto; }
        
        .section-title-wrapper { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem; 
            border-bottom-width: 2px;
            padding-bottom: 0.5rem; 
        }
        .light-mode .section-title-wrapper { border-bottom-color: var(--intersect-blue); }
        .dark-mode .section-title-wrapper { border-bottom-color: var(--intersect-orange); }

        .section-title {
            font-size: 1.875rem; font-weight: 600; 
        }
        .light-mode .section-title { color: var(--intersect-blue); }
        .dark-mode .section-title { color: var(--intersect-orange); }
        
        .download-png-button {
            padding: 0.3rem 0.6rem; 
            font-size: 0.8rem;
            border-radius: 0.375rem;
        }


        .list-item::before { content: "âœ“"; margin-right: 0.5rem; font-weight: bold; }
        .light-mode .list-item::before { color: var(--intersect-blue); } 
        .dark-mode .list-item::before { color: var(--intersect-orange); } 


        .theme-toggle-button {
            position: fixed; top: 20px; right: 20px; padding: 0.75rem; border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000; cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
         .light-mode .theme-toggle-button { background-color: var(--intersect-blue); color: white; }
        .light-mode .theme-toggle-button:hover { background-color: #1c3fb5; }
        
        .upload-section { }
        .file-input-label, .action-button { 
            padding: 0.5rem 1rem; border-radius: 0.375rem; cursor: pointer;
            font-weight: 500; transition: background-color 0.2s ease-in-out;
            display: inline-flex; align-items: center; 
        }
        input[type="file"] { display: none; }
        #fileName { margin-left: 1rem; font-style: italic; }
        .action-button:disabled { opacity: 0.5; cursor: not-allowed; }

        .container { min-height: calc(100vh - 4rem); }
        .placeholder-text { text-align: center; padding: 1rem; }
        .post-card-content { flex-grow: 1; }
        select#postSelectorDropdown {
            width: 100%; padding: 0.75rem; border-radius: 0.375rem; 
            border-width: 1px; margin-bottom: 1.5rem; cursor: pointer;
        }
        #individualPostDetailsContainer .detail-item { padding: 0.5rem 0; border-bottom-width: 1px; }
         .light-mode #individualPostDetailsContainer .detail-item { border-bottom-color: #e5e7eb; }
        .dark-mode #individualPostDetailsContainer .detail-item { border-bottom-color: #4b5563; }
        #individualPostDetailsContainer .detail-item:last-child { border-bottom-width: 0; }
        #individualPostDetailsContainer .detail-label { font-weight: 600; }
        #individualPostDetailsContainer .post-text-display {
            white-space: pre-wrap; word-break: break-word; max-height: 200px; 
            overflow-y: auto; padding: 0.5rem; border-radius: 0.25rem;
        }
        .light-mode #individualPostDetailsContainer .post-text-display { background-color: #f9fafb; }
        .dark-mode #individualPostDetailsContainer .post-text-display { background-color: #4b5563; }
        .hidden-section { display: none !important; }

        /* HTML Slide Show Styles */
        #htmlSlideShowContainer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 2000; overflow-y: auto; padding: 2rem; 
        }
        .light-mode #htmlSlideShowContainer { background-color: var(--intersect-cream); } 
        .dark-mode #htmlSlideShowContainer { background-color: var(--intersect-dark-bg); } 

        .html-slide {
            border-radius: 0.5rem; padding: 2rem; 
            margin: 1rem auto; 
            max-width: 900px; 
            min-height: 500px; 
            display: none; 
            flex-direction: column; justify-content: center; 
            align-items: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden; 
        }
        .light-mode .html-slide { background-color: #ffffff; color: var(--intersect-dark-text);}
        .dark-mode .html-slide { background-color: var(--intersect-dark-card); color: var(--intersect-light-text);}
        
        .html-slide.active { display: flex; }
        .html-slide-title { font-size: 2em; font-weight: bold; margin-bottom: 0.5em; text-align: center;} 
        .light-mode .html-slide-title { color: var(--intersect-blue); }
        .dark-mode .html-slide-title { color: var(--intersect-orange); }

        .html-slide-explainer { font-size: 0.9em; font-style: italic; margin-bottom: 1.5em; text-align: center; max-width: 80%;}
        .html-slide-content { 
            width: 100%; 
            text-align: left; 
            overflow-y: auto; 
            flex-grow: 1; 
            padding: 0 1rem; 
        }
        .html-slide-content table { margin: 1em auto; width: auto; max-width: 100%; font-size: 0.85em; } 
        .html-slide-content ul { list-style: disc; padding-left: 1.5em; font-size: 0.9em; }
        .html-slide-content .grid { font-size: 0.9em; } 
        .html-slide-content .metric-card { padding: 0.75rem; }
        .html-slide-content .metric-value { font-size: 1.5rem; }
        .html-slide-content .metric-label { font-size: 0.75rem; }


        #slideShowControls {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); z-index: 2010;
            display: flex; gap: 1rem;
        }
        #slideShowControls button {
            padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .light-mode #slideShowControls button { background-color: var(--intersect-blue); color: white; }
        .light-mode #slideShowControls button:hover { background-color: #1c3fb5; }
        .dark-mode #slideShowControls button { background-color: var(--intersect-orange); color: white; }
        .dark-mode #slideShowControls button:hover { background-color: #dd6b20; }
        
        #exitSlideShowButton {
            position: fixed; top: 30px; right: 30px; z-index: 2010;
        }

        #howToGuide ol li { margin-bottom: 0.5rem; }
        #howToGuide strong { font-weight: 600; }
        .light-mode #howToGuide strong { color: var(--intersect-blue); }
        .dark-mode #howToGuide strong { color: var(--intersect-orange); }


        @media print {
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            #mainReportContainer, #slideShowControls, #exitSlideShowButton, #theme-toggle, .download-png-button { 
                display: none !important;
            }
            #htmlSlideShowContainer {
                position: static !important; 
                width: auto !important; 
                height: auto !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important; 
                background-color: transparent !important;
            }
            .html-slide {
                display: flex !important; 
                width: 100% !important; 
                height: auto !important; 
                min-height: 0 !important; 
                margin: 0 0 20px 0 !important; 
                box-shadow: none !important;
                border: 1px solid #ccc !important; 
                page-break-after: always !important; 
                overflow: visible !important; 
            }
             .html-slide:last-child {
                page-break-after: avoid !important;
            }
            .html-slide-content {
                overflow-y: visible !important; 
                max-height: none !important;
            }
        }

    </style>
</head>
<body class="light-mode p-4 md:p-8">
    <div id="mainReportContainer"> 
        <div class="container mx-auto max-w-5xl">

            <button id="theme-toggle" class="theme-toggle-button" title="Toggle dark/light mode">
                <i class="fas fa-moon"></i>
            </button>

            <header class="mb-6 text-center pt-8 md:pt-12">
                <img src="logo/logo.png" alt="Company Logo" class="company-logo mx-auto mb-4 h-16"> 
                
                <h1 id="reportMainTitle" class="text-4xl font-bold text-main-header">@IntersectMBO Analytics Report</h1>
                <p class="text-xl text-sub-header mt-2">Interactive Account Analytics Report</p>
                <p id="data-period-display" class="text-sm text-muted">Upload a CSV file to view analytics.</p>
            </header>

            <section class="upload-section report-section">
                <h2 class="text-xl font-semibold mb-3">Upload New CSV Data</h2>
                <div class="flex items-center mb-3">
                    <label for="csvFileInput" class="file-input-label">
                        <i class="fas fa-file-csv mr-2"></i>Choose CSV File
                    </label>
                    <input type="file" id="csvFileInput" accept=".csv">
                    <span id="fileName" class="text-muted">No file chosen</span>
                </div>
                <div class="space-x-2 flex flex-wrap gap-2"> 
                    <button id="loadCsvButton" class="action-button load-button">
                        <i class="fas fa-sync-alt mr-2"></i>Load and Process Data
                    </button>
                    <button id="viewHtmlSlideShowButton" class="action-button slideshow-button" disabled>
                        <i class="fas fa-tv mr-2"></i>View as Slides
                    </button>
                </div>
                <p id="uploadStatus" class="text-sm mt-2"></p>
            </section>

            <div id="contentAnalyticsSections">
                <section id="individual-post-analysis" class="report-section">
                    <div class="section-title-wrapper">
                        <h2 class="section-title">Individual Post Analysis</h2>
                        <button class="action-button download-png-button" data-section-id="individual-post-analysis" title="Download as PNG" disabled><i class="fas fa-image"></i></button>
                    </div>
                    <select id="postSelectorDropdown" disabled>
                        <option value="">Upload a Content CSV to select a post</option>
                    </select>
                    <div id="individualPostDetailsContainer" class="mt-4">
                        <p class="text-muted placeholder-text">Select a post from the dropdown above to view its details.</p>
                    </div>
                </section>
                <section id="aggregate-metrics-content" class="report-section">
                    <div class="section-title-wrapper">
                        <h2 class="section-title">Content Performance Metrics</h2>
                        <button class="action-button download-png-button" data-section-id="aggregate-metrics-content" title="Download as PNG" disabled><i class="fas fa-image"></i></button>
                    </div>
                    <div class="table-container">
                        <table id="metricsTableContent" class="min-w-full divide-y">
                            <thead class="table-header">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-sort-col="0">Metric <span class="sort-icon"></span></th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-sort-col="1" data-sort-type="number">Total <span class="sort-icon"></span></th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" data-sort-col="2" data-sort-type="number">Average per Post <span class="sort-icon"></span></th>
                                </tr>
                            </thead>
                            <tbody id="metricsTableBodyContent" class="divide-y">
                                <tr><td colspan="3" class="px-6 py-10 text-center text-muted placeholder-text">Upload a Content CSV to view aggregate metrics.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
                <section id="engagement-insights-content" class="report-section">
                     <div class="section-title-wrapper">
                        <h2 class="section-title">Content Engagement Insights</h2>
                        <button class="action-button download-png-button" data-section-id="engagement-insights-content" title="Download as PNG" disabled><i class="fas fa-image"></i></button>
                    </div>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="metric-card text-center">
                            <div id="engagementRateDisplayContent" class="metric-value">N/A</div>
                            <div class="metric-label text-muted">Overall Engagement Rate</div>
                            <p class="text-xs text-muted mt-1">(Based on 'Engagements' column / Total Impressions)</p>
                        </div>
                        <div class="p-6"> 
                            <h3 class="text-lg font-semibold mb-2">Key Engagement Drivers:</h3>
                            <ul id="engagementDriversListContent" class="list-disc list-inside space-y-1">
                                <li class="text-muted placeholder-text">Upload a Content CSV to view key engagement drivers.</li>
                            </ul>
                        </div>
                    </div>
                </section>
                <section id="top-posts-content" class="report-section">
                    <div class="section-title-wrapper">
                        <h2 class="section-title">Top Performing Posts Highlights</h2>
                        <button class="action-button download-png-button" data-section-id="top-posts-content" title="Download as PNG" disabled><i class="fas fa-image"></i></button>
                    </div>
                    <div id="topPostsContainerContent" class="grid md:grid-cols-2 gap-6">
                        <p class="text-muted placeholder-text col-span-full">Upload a Content CSV to view top performing posts.</p>
                    </div>
                </section>
            </div>
            <section id="accountOverviewSection" class="report-section hidden-section">
                 <div class="section-title-wrapper">
                    <h2 class="section-title">Account Overview Analytics</h2>
                    <button class="action-button download-png-button" data-section-id="accountOverviewSection" title="Download as PNG" disabled><i class="fas fa-image"></i></button>
                </div>
                <div id="overviewSummaryCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <p class="text-muted placeholder-text col-span-full">Loading overview summary...</p>
                </div>
                <h3 class="text-xl font-semibold mb-4">Daily Overview Data</h3>
                <div class="table-container">
                    <table id="overviewDailyTable" class="min-w-full divide-y">
                        <thead id="overviewDailyTableHead" class="table-header"></thead>
                        <tbody id="overviewDailyTableBody" class="divide-y">
                            <tr><td colspan="10" class="px-6 py-10 text-center text-muted placeholder-text">Loading daily overview data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
            
            <section id="interpretive-sections-container" class="report-section">
                <div id="howToGuide" class="p-6">
                    <h2 class="text-2xl font-semibold mb-4 text-center section-title">How to Use This Page</h2>
                    <ol class="list-decimal list-inside space-y-3 text-lg">
                        <li><strong>Prepare Your Data:</strong> Export your analytics data from X (Twitter) as a CSV file. This tool accepts both content-level (per post) and account overview (daily) CSVs.</li>
                        <li><strong>Upload CSV:</strong> Click "Choose CSV File", select your file, then click "Load and Process Data".</li>
                        <li><strong>View Analytics:</strong> Once loaded, relevant sections like Performance Metrics, Engagement Insights, and Top Posts will populate. The main report title will update if a channel name is found in your CSV.</li>
                        <li><strong>Individual Post Details:</strong> For content CSVs, use the dropdown in the "Individual Post Analysis" section to see detailed metrics for each post.</li>
                        <li><strong>Dynamic Insights:</strong> Sections for "Key Content Themes", "Key Observations", and "Conclusion" will automatically generate based on your uploaded data.</li>
                        <li><strong>Download as PNG:</strong> Click the <i class="fas fa-image"></i> icon next to any section title to download that section as a PNG image.</li>
                        <li><strong>View as Slides:</strong> Click "View as Slides" to see the report in a presentation format. Use the navigation controls at the bottom.</li>
                        <li><strong>Toggle Theme:</strong> Use the <i class="fas fa-moon"></i> / <i class="fas fa-sun"></i> icon at the top right to switch between light and dark modes.</li>
                    </ol>
                </div>

                <section id="content-themes-dynamic" class="mb-12 report-section hidden-section"> 
                    <div class="section-title-wrapper">
                        <h2 class="section-title">Key Content Themes</h2>
                        <button class="action-button download-png-button" data-section-id="content-themes-dynamic" title="Download as PNG" disabled><i class="fas fa-image"></i></button>
                    </div>
                    <div id="contentThemesBody" class="p-6">
                        <p class="text-muted placeholder-text">Upload data to generate content themes.</p>
                    </div>
                </section>
                <section id="key-observations-dynamic" class="mb-12 report-section hidden-section">
                    <div class="section-title-wrapper">
                        <h2 class="section-title">Key Observations & Potential Insights</h2>
                        <button class="action-button download-png-button" data-section-id="key-observations-dynamic" title="Download as PNG" disabled><i class="fas fa-image"></i></button>
                    </div>
                     <div id="keyObservationsBody" class="p-6">
                        <p class="text-muted placeholder-text">Upload data to generate key observations.</p>
                    </div>
                </section>
                <section id="conclusion-dynamic" class="mb-12 report-section hidden-section">
                    <div class="section-title-wrapper">
                        <h2 class="section-title">Conclusion</h2>
                        <button class="action-button download-png-button" data-section-id="conclusion-dynamic" title="Download as PNG" disabled><i class="fas fa-image"></i></button>
                    </div>
                    <div id="conclusionBody" class="p-6">
                        <p class="text-muted placeholder-text">Upload data to generate a conclusion.</p>
                    </div>
                </section>
            </section>
            <footer class="text-center mt-12 py-6 border-t text-muted"><p class="text-sm">&copy; <span id="currentYear"></span> IntersectMBO</p></footer>
        </div>
    </div>

    <!-- HTML Slide Show Container -->
    <div id="htmlSlideShowContainer" class="hidden-section">
        <button id="exitSlideShowButton" class="action-button">
            <i class="fas fa-times mr-2"></i>Exit Slide Show
        </button>
        <div id="slideContentArea" class="mt-12">
            <!-- Slides will be injected here -->
        </div>
        <div id="slideShowControls">
            <button id="prevSlideButton"><i class="fas fa-arrow-left mr-1"></i> Previous</button>
            <span id="slideIndicator" class="self-center"></span>
            <button id="nextSlideButton">Next <i class="fas fa-arrow-right ml-1"></i></button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM fully loaded and parsed'); 

        let parsedCsvData = []; 
        let currentCsvType = null; 
        let currentCsvHeaders = []; 
        let currentChannelName = "IntersectMBO"; 
        let htmlSlides = [];
        let currentSlideIndex = 0;

        const themeToggle = document.getElementById('theme-toggle');
        const body = document.body;
        const moonIcon = '<i class="fas fa-moon"></i>';
        const sunIcon = '<i class="fas fa-sun"></i>';

        function applyTheme(theme) {
            body.classList.toggle('dark-mode', theme === 'dark');
            body.classList.toggle('light-mode', theme !== 'dark');
            themeToggle.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
            localStorage.setItem('theme', theme);
        }
        const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        applyTheme(savedTheme);
        themeToggle.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
        });

        const csvFileInput = document.getElementById('csvFileInput');
        const loadCsvButton = document.getElementById('loadCsvButton');
        const viewHtmlSlideShowButton = document.getElementById('viewHtmlSlideShowButton'); 
        const fileNameDisplay = document.getElementById('fileName');
        const uploadStatus = document.getElementById('uploadStatus');
        const dataPeriodDisplay = document.getElementById('data-period-display');
        const reportMainTitle = document.getElementById('reportMainTitle'); 
        
        const mainReportContainer = document.getElementById('mainReportContainer'); 
        const htmlSlideShowContainer = document.getElementById('htmlSlideShowContainer');
        const slideContentArea = document.getElementById('slideContentArea');
        const prevSlideButton = document.getElementById('prevSlideButton');
        const nextSlideButton = document.getElementById('nextSlideButton');
        const exitSlideShowButton = document.getElementById('exitSlideShowButton');
        const slideIndicator = document.getElementById('slideIndicator');

        const contentAnalyticsSections = document.getElementById('contentAnalyticsSections');
        const metricsTableBodyContent = document.getElementById('metricsTableBodyContent');
        const engagementRateDisplayContent = document.getElementById('engagementRateDisplayContent');
        const engagementDriversListContent = document.getElementById('engagementDriversListContent');
        const topPostsContainerContent = document.getElementById('topPostsContainerContent');
        const postSelectorDropdown = document.getElementById('postSelectorDropdown');
        const individualPostDetailsContainer = document.getElementById('individualPostDetailsContainer');
        
        const accountOverviewSection = document.getElementById('accountOverviewSection');
        const overviewSummaryCards = document.getElementById('overviewSummaryCards');
        const overviewDailyTableHead = document.getElementById('overviewDailyTableHead');
        const overviewDailyTableBody = document.getElementById('overviewDailyTableBody');

        // How-to guide and dynamic insight sections
        const howToGuide = document.getElementById('howToGuide');
        const contentThemesDynamicSection = document.getElementById('content-themes-dynamic');
        const keyObservationsDynamicSection = document.getElementById('key-observations-dynamic');
        const conclusionDynamicSection = document.getElementById('conclusion-dynamic');

        const contentThemesBody = document.getElementById('contentThemesBody');
        const keyObservationsBody = document.getElementById('keyObservationsBody');
        const conclusionBody = document.getElementById('conclusionBody');

        const CONTENT_METRIC_COLUMNS = ['Impressions', 'Likes', 'Engagements', 'Bookmarks', 'Shares', 'New follows', 'Replies', 'Reposts', 'Profile visits', 'Detail Expands', 'URL Clicks', 'Hashtag Clicks', 'Permalink Clicks'];
        const OVERVIEW_METRIC_COLUMNS = ['Impressions', 'Likes', 'Engagements', 'Bookmarks', 'Shares', 'New follows', 'Unfollows', 'Replies', 'Reposts', 'Profile visits', 'Create Post', 'Video views', 'Media views'];

        const normalizeHeader = (header) => header ? header.toLowerCase().replace(/\s+/g, '') : '';
        
        const STOP_WORDS = new Set([
            'a', 'about', 'above', 'after', 'again', 'against', 'all', 'am', 'an', 'and', 'any', 'are', 'aren\'t', 'as', 'at', 
            'be', 'because', 'been', 'before', 'being', 'below', 'between', 'both', 'but', 'by', 'can\'t', 'cannot', 'could', 
            'couldn\'t', 'did', 'didn\'t', 'do', 'does', 'doesn\'t', 'doing', 'don\'t', 'down', 'during', 'each', 'few', 'for', 
            'from', 'further', 'had', 'hadn\'t', 'has', 'hasn\'t', 'have', 'haven\'t', 'having', 'he', 'he\'d', 'he\'ll', 'he\'s', 
            'her', 'here', 'here\'s', 'hers', 'herself', 'him', 'himself', 'his', 'how', 'how\'s', 'i', 'i\'d', 'i\'ll', 'i\'m', 
            'i\'ve', 'if', 'in', 'into', 'is', 'isn\'t', 'it', 'it\'s', 'its', 'itself', 'let\'s', 'me', 'more', 'most', 'mustn\'t', 
            'my', 'myself', 'no', 'nor', 'not', 'of', 'off', 'on', 'once', 'only', 'or', 'other', 'ought', 'our', 'ours', 
            'ourselves', 'out', 'over', 'own', 'same', 'shan\'t', 'she', 'she\'d', 'she\'ll', 'she\'s', 'should', 'shouldn\'t', 
            'so', 'some', 'such', 'than', 'that', 'that\'s', 'the', 'their', 'theirs', 'them', 'themselves', 'then', 'there', 
            'there\'s', 'these', 'they', 'they\'d', 'they\'ll', 'they\'re', 'they\'ve', 'this', 'those', 'through', 'to', 'too', 
            'under', 'until', 'up', 'very', 'was', 'wasn\'t', 'we', 'we\'d', 'we\'ll', 'we\'re', 'we\'ve', 'were', 'weren\'t', 
            'what', 'what\'s', 'when', 'when\'s', 'where', 'where\'s', 'which', 'while', 'who', 'who\'s', 'whom', 'why', 'why\'s', 
            'with', 'won\'t', 'would', 'wouldn\'t', 'you', 'you\'d', 'you\'ll', 'you\'re', 'you\'ve', 'your', 'yours', 'yourself', 
            'yourselves', 'http', 'https', 'www', 'com', 'twitter', 'cardano', 'ada'
        ]);


        csvFileInput.addEventListener('change', () => {
            if (csvFileInput.files.length > 0) {
                fileNameDisplay.textContent = csvFileInput.files[0].name;
                uploadStatus.textContent = '';
            } else {
                fileNameDisplay.textContent = 'No file chosen';
            }
        });

        loadCsvButton.addEventListener('click', () => {
            console.log('Load CSV button clicked'); 
            if (csvFileInput.files.length === 0) {
                uploadStatus.textContent = 'Please choose a CSV file first.';
                uploadStatus.style.color = 'red';
                return;
            }
            const file = csvFileInput.files[0];
            if (file.type !== 'text/csv' && !file.name.toLowerCase().endsWith('.csv')) {
                 uploadStatus.textContent = 'Invalid file type. Please upload a .csv file.';
                 uploadStatus.style.color = 'red';
                 return;
            }

            uploadStatus.textContent = 'Processing...';
            uploadStatus.style.color = 'inherit'; 
            if(viewHtmlSlideShowButton) viewHtmlSlideShowButton.disabled = true;
            disablePngDownloadButtons(); 

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csvData = event.target.result;
                    currentChannelName = "IntersectMBO"; 
                    parsedCsvData = parseCSV(csvData); 
                    
                    if (!parsedCsvData || parsedCsvData.length === 0) {
                        throw new Error("CSV is empty or could not be parsed.");
                    }
                    currentCsvHeaders = Object.keys(parsedCsvData[0] || {}); 
                    currentCsvType = detectCsvType(currentCsvHeaders);
                    if (!currentCsvType) {
                        throw new Error("Could not determine CSV type. Ensure headers are correct (e.g., 'Post id' and 'Post text' for Content, or 'Date' and 'Unfollows' for Overview).");
                    }
                    
                    if (reportMainTitle) { 
                         reportMainTitle.textContent = `@${currentChannelName} Analytics Report`;
                    }

                    processAndDisplayData(parsedCsvData, file.name, currentCsvType);
                    const displayChannel = currentChannelName === "IntersectMBO" ? "IntersectMBO (Default)" : `@${currentChannelName}`;
                    uploadStatus.textContent = `Successfully loaded and processed '${file.name}' (${currentCsvType} data for ${displayChannel}).`;
                    uploadStatus.style.color = 'green';
                    
                    // Manage visibility of how-to guide and dynamic insights
                    if(howToGuide) howToGuide.classList.add('hidden-section');
                    if(contentThemesDynamicSection) contentThemesDynamicSection.classList.remove('hidden-section');
                    if(keyObservationsDynamicSection) keyObservationsDynamicSection.classList.remove('hidden-section');
                    if(conclusionDynamicSection) conclusionDynamicSection.classList.remove('hidden-section');
                    
                    if(viewHtmlSlideShowButton) viewHtmlSlideShowButton.disabled = false;
                    enablePngDownloadButtons(); 
                } catch (error) {
                    console.error("Error processing CSV:", error);
                    parsedCsvData = []; 
                    currentCsvType = null;
                    currentCsvHeaders = [];
                    currentChannelName = "IntersectMBO"; 
                     if (reportMainTitle) reportMainTitle.textContent = "@IntersectMBO Analytics Report"; 
                    uploadStatus.textContent = `Error: ${error.message}. Check console.`;
                    uploadStatus.style.color = 'red';
                    resetUI(); // This will show the how-to guide again
                }
            };
            reader.onerror = function() {
                uploadStatus.textContent = 'Error reading file.';
                uploadStatus.style.color = 'red';
                parsedCsvData = [];
                currentCsvType = null;
                currentCsvHeaders = [];
                currentChannelName = "IntersectMBO"; 
                if (reportMainTitle) reportMainTitle.textContent = "@IntersectMBO Analytics Report"; 
                resetUI(); // This will show the how-to guide again
            };
            reader.readAsText(file);
        });
        
        if (viewHtmlSlideShowButton) {
            viewHtmlSlideShowButton.addEventListener('click', startHtmlSlideShow);
        }
        if (exitSlideShowButton) {
            exitSlideShowButton.addEventListener('click', exitHtmlSlideShow);
        }
        if (prevSlideButton) {
            prevSlideButton.addEventListener('click', showPrevSlide);
        }
        if (nextSlideButton) {
            nextSlideButton.addEventListener('click', showNextSlide);
        }


        function resetUI() {
            metricsTableBodyContent.innerHTML = '<tr><td colspan="3" class="px-6 py-10 text-center text-muted placeholder-text">Upload a Content CSV.</td></tr>';
            engagementRateDisplayContent.textContent = "N/A";
            engagementDriversListContent.innerHTML = '<li class="text-muted placeholder-text">Upload a Content CSV.</li>';
            topPostsContainerContent.innerHTML = '<p class="text-muted placeholder-text col-span-full">Upload a Content CSV.</p>';
            postSelectorDropdown.innerHTML = '<option value="">Upload a Content CSV</option>';
            postSelectorDropdown.disabled = true;
            individualPostDetailsContainer.innerHTML = '<p class="text-muted placeholder-text">Upload a Content CSV.</p>';
            contentAnalyticsSections.classList.add('hidden-section');
            accountOverviewSection.classList.add('hidden-section');
            dataPeriodDisplay.textContent = "Upload a CSV file to view analytics.";
            
            if(howToGuide) howToGuide.classList.remove('hidden-section');
            if(contentThemesDynamicSection) contentThemesDynamicSection.classList.add('hidden-section');
            if(keyObservationsDynamicSection) keyObservationsDynamicSection.classList.add('hidden-section');
            if(conclusionDynamicSection) conclusionDynamicSection.classList.add('hidden-section');

            if(viewHtmlSlideShowButton) viewHtmlSlideShowButton.disabled = true;
            contentThemesBody.innerHTML = '<p class="text-muted placeholder-text">Upload data to generate content themes.</p>';
            keyObservationsBody.innerHTML = '<p class="text-muted placeholder-text">Upload data to generate key observations.</p>';
            conclusionBody.innerHTML = '<p class="text-muted placeholder-text">Upload data to generate a conclusion.</p>';
            currentChannelName = "IntersectMBO"; 
            if(reportMainTitle) reportMainTitle.textContent = "@IntersectMBO Analytics Report"; 
            disablePngDownloadButtons();
        }

        function detectCsvType(headers) {
            const normalizedHeaders = headers.map(normalizeHeader);
            const hasPostId = normalizedHeaders.includes(normalizeHeader('Post id'));
            const hasPostText = normalizedHeaders.includes(normalizeHeader('Post text'));
            const hasDate = normalizedHeaders.includes(normalizeHeader('Date'));
            const hasUnfollows = normalizedHeaders.includes(normalizeHeader('Unfollows'));
            const hasCreatePost = normalizedHeaders.includes(normalizeHeader('Create Post'));
            if (hasPostId && hasPostText) return 'content';
            if (hasDate && (hasUnfollows || hasCreatePost)) return 'overview';
            return null; 
        }

        function parseCSV(csvText) { 
            const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== ''); 
            if (lines.length < 2) return []; 
            const rawHeaders = lines[0].split(',');
            const headers = rawHeaders.map(h => h.trim());
            currentCsvHeaders = headers; 

            const channelNameHeaders = ["Screen name", "Author", "Account", "Channel Name", "User Name", "Username"];
            let foundChannelName = null; 
            for (const chHeader of channelNameHeaders) {
                const actualHeader = headers.find(h => normalizeHeader(h) === normalizeHeader(chHeader));
                if (actualHeader && lines.length > 1) { 
                    const firstDataLineValues = [];
                    let currentValTmp = '';
                    let inQuotesTmp = false;
                    for (let j = 0; j < lines[1].length; j++) {
                        const char = lines[1][j];
                        if (char === '"') {
                            if (inQuotesTmp && j + 1 < lines[1].length && lines[1][j+1] === '"') { currentValTmp += '"'; j++; continue; }
                            inQuotesTmp = !inQuotesTmp;
                        } else if (char === ',' && !inQuotesTmp) {
                            firstDataLineValues.push(currentValTmp.trim()); currentValTmp = '';
                        } else { currentValTmp += char; }
                    }
                    firstDataLineValues.push(currentValTmp.trim());
                    
                    const headerIndex = headers.indexOf(actualHeader);
                    if (headerIndex !== -1 && firstDataLineValues[headerIndex] && firstDataLineValues[headerIndex].trim() !== "") {
                        foundChannelName = firstDataLineValues[headerIndex].replace(/^@/, ''); 
                        break; 
                    }
                }
            }
            currentChannelName = foundChannelName || "IntersectMBO"; 

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let currentVal = '';
                let inQuotes = false;
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        if (inQuotes && j + 1 < lines[i].length && lines[i][j+1] === '"') {
                            currentVal += '"'; j++; continue;
                        }
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(currentVal.trim()); currentVal = '';
                    } else {
                        currentVal += char;
                    }
                }
                values.push(currentVal.trim());
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        let val = values[index];
                        if (val.startsWith('"') && val.endsWith('"')) val = val.substring(1, val.length - 1);
                        row[header] = val.replace(/""/g, '"');
                    });
                    data.push(row);
                } else {
                    console.warn(`Skipping malformed row ${i+1}: expected ${headers.length}, got ${values.length}. Line: ${lines[i]}`);
                }
            }
            return data;
        }
        
        function processAndDisplayData(data, fileName, csvType) {
            dataPeriodDisplay.textContent = `Data from: ${fileName}`;
            let totals = {}; 

            if (csvType === 'content') {
                contentAnalyticsSections.classList.remove('hidden-section');
                accountOverviewSection.classList.add('hidden-section');
                totals = displayContentAnalytics(data); 
            } else if (csvType === 'overview') {
                accountOverviewSection.classList.remove('hidden-section');
                contentAnalyticsSections.classList.add('hidden-section');
                totals = displayOverviewAnalytics(data); 
            }
            const themes = (csvType === 'content') ? generateThemesFromData(data) : [];
            const observations = generateObservationsFromData(data, csvType, totals, currentCsvHeaders);
            const conclusion = generateDynamicConclusion(themes, observations);

            displayDynamicInsights(themes, observations, conclusion);
        }

        function displayDynamicInsights(themes, observations, conclusion) {
            contentThemesBody.innerHTML = '';
            if (themes && themes.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside space-y-1';
                themes.forEach(theme => {
                    const li = document.createElement('li');
                    li.innerHTML = `<strong>${theme.word}:</strong> Appeared ${theme.count} times.`;
                    ul.appendChild(li);
                });
                contentThemesBody.appendChild(ul);
            } else {
                contentThemesBody.innerHTML = '<p class="text-muted placeholder-text">No significant content themes identified from the data.</p>';
            }

            keyObservationsBody.innerHTML = '';
            if (observations && observations.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-disc list-inside space-y-1';
                observations.forEach(obs => {
                    const li = document.createElement('li');
                    li.textContent = obs;
                    ul.appendChild(li);
                });
                keyObservationsBody.appendChild(ul);
            } else {
                keyObservationsBody.innerHTML = '<p class="text-muted placeholder-text">No specific key observations generated from the data.</p>';
            }

            conclusionBody.innerHTML = `<p class="leading-relaxed">${conclusion || "No overall conclusion could be drawn from the provided data."}</p>`;
        }


        function displayContentAnalytics(data) {
            const numPosts = data.length;
            const headers = currentCsvHeaders;
            const totals = {};
            CONTENT_METRIC_COLUMNS.forEach(col => totals[col] = 0); 
            
            data.forEach(row => {
                CONTENT_METRIC_COLUMNS.forEach(colName => {
                    let actualColName = headers.find(h => normalizeHeader(h) === normalizeHeader(colName));
                    if(actualColName){
                        const val = parseFloat(String(row[actualColName] || '0').replace(/,/g, '')); 
                        if (!isNaN(val)) totals[colName] += val;
                    }
                });
            });
            metricsTableBodyContent.innerHTML = ''; 
            const newRowPosts = document.createElement('tr');
            newRowPosts.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-medium">Posts Analyzed</td><td class="px-6 py-4 whitespace-nowrap">${numPosts.toLocaleString()}</td><td class="px-6 py-4 whitespace-nowrap">-</td>`;
            metricsTableBodyContent.appendChild(newRowPosts);
            CONTENT_METRIC_COLUMNS.forEach(colName => {
                const total = totals[colName] || 0; 
                const average = numPosts > 0 ? (total / numPosts).toFixed(2) : '0.00';
                const row = document.createElement('tr');
                row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap">${colName}</td><td class="px-6 py-4 whitespace-nowrap">${total.toLocaleString()}</td><td class="px-6 py-4 whitespace-nowrap">${average}</td>`;
                metricsTableBodyContent.appendChild(row);
            });
            initializeTableSorting(document.getElementById('metricsTableContent'));
            const totalImpressions = totals['Impressions'] || 0;
            const totalEngagements = totals['Engagements'] || 0;
            engagementRateDisplayContent.textContent = totalImpressions > 0 ? ((totalEngagements / totalImpressions) * 100).toFixed(2) + '%' : 'N/A';
            engagementDriversListContent.innerHTML = `<li>Likes: ${(totals['Likes'] || 0).toLocaleString()}</li><li>Reposts: ${(totals['Reposts'] || 0).toLocaleString()}</li><li>Detail Expands: ${(totals['Detail Expands'] || 0).toLocaleString()}</li>`;
            topPostsContainerContent.innerHTML = ''; 
            const topPostMetricsContent = [
                { name: 'Engagements', title: 'Top Post by Engagements' }, { name: 'Impressions', title: 'Top Post by Impressions' },
                { name: 'Likes', title: 'Top Post by Likes' }, { name: 'Reposts', title: 'Top Post by Reposts' }
            ];
            if (numPosts === 0) {
                 topPostsContainerContent.innerHTML = `<p class="text-muted placeholder-text col-span-full">No data to determine top posts.</p>`;
            } else {
                topPostMetricsContent.forEach(metricInfo => {
                    const metricHeaderKey = headers.find(h => normalizeHeader(h) === normalizeHeader(metricInfo.name));
                    const topPostData = findTopPost(data, metricHeaderKey, headers); 
                    const card = createPostCard(topPostData, metricInfo.title, metricInfo.name, topPostData ? topPostData.value : 0, headers); 
                    topPostsContainerContent.appendChild(card);
                });
            }
            populatePostSelectorDropdown(data);
            return totals; 
        }
        
        function displayOverviewAnalytics(data) {
            const numDays = data.length;
            const headers = currentCsvHeaders;
            const overviewTotals = {};
            OVERVIEW_METRIC_COLUMNS.forEach(col => overviewTotals[col] = 0); 
            let totalNewFollows = 0, totalUnfollows = 0;
            data.forEach(dayData => {
                OVERVIEW_METRIC_COLUMNS.forEach(colName => {
                    let actualColName = headers.find(h => normalizeHeader(h) === normalizeHeader(colName));
                    if(actualColName) {
                        const val = parseFloat(String(dayData[actualColName] || '0').replace(/,/g, ''));
                        if (!isNaN(val)) {
                            overviewTotals[colName] += val;
                            if (normalizeHeader(colName) === 'newfollows') totalNewFollows += val;
                            if (normalizeHeader(colName) === 'unfollows') totalUnfollows += val;
                        }
                    }
                });
            });
            const netFollowerGrowth = totalNewFollows - totalUnfollows;
            overviewSummaryCards.innerHTML = `
                ${createOverviewMetricCard('Total Impressions', (overviewTotals['Impressions'] || 0).toLocaleString())}
                ${createOverviewMetricCard('Total Engagements', (overviewTotals['Engagements'] || 0).toLocaleString())}
                ${createOverviewMetricCard('Net Follower Growth', netFollowerGrowth.toLocaleString(), netFollowerGrowth >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-500 dark:text-red-400')}
                ${createOverviewMetricCard('Total Posts Created', (overviewTotals['Create Post'] || 0).toLocaleString())}
                ${createOverviewMetricCard('Avg Daily Impressions', numDays > 0 ? ((overviewTotals['Impressions'] || 0) / numDays).toFixed(0).toLocaleString() : 'N/A')}
                ${createOverviewMetricCard('Avg Daily Profile Visits', numDays > 0 ? ((overviewTotals['Profile visits'] || 0) / numDays).toFixed(0).toLocaleString() : 'N/A')}
                ${createOverviewMetricCard('Total Video Views', (overviewTotals['Video views'] || 0).toLocaleString())}
                ${createOverviewMetricCard('Total Media Views', (overviewTotals['Media views'] || 0).toLocaleString())}`;
            overviewDailyTableHead.innerHTML = ''; 
            const headerRow = document.createElement('tr');
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.className = "px-6 py-3 text-left text-xs font-medium uppercase tracking-wider";
                th.textContent = headerText;
                th.dataset.sortCol = headers.indexOf(headerText);
                if (headerText.toLowerCase() !== 'date') th.dataset.sortType = 'number';
                th.innerHTML += ' <span class="sort-icon"></span>';
                headerRow.appendChild(th);
            });
            overviewDailyTableHead.appendChild(headerRow);
            overviewDailyTableBody.innerHTML = '';
            if (numDays === 0) {
                overviewDailyTableBody.innerHTML = `<tr><td colspan="${headers.length}" class="px-6 py-10 text-center text-muted">No daily data available.</td></tr>`;
            } else {
                data.forEach(dayData => {
                    const row = document.createElement('tr');
                    headers.forEach(header => {
                        const td = document.createElement('td');
                        td.className = "px-6 py-4 whitespace-nowrap";
                        let value = dayData[header] || '0';
                        if(header.toLowerCase() !== 'date' && !isNaN(parseFloat(value.replace(/,/g,'')))) {
                            value = parseFloat(value.replace(/,/g,'')).toLocaleString();
                        }
                        td.textContent = value;
                        row.appendChild(td);
                    });
                    overviewDailyTableBody.appendChild(row);
                });
            }
            initializeTableSorting(document.getElementById('overviewDailyTable'));
            return overviewTotals; 
        }

        // --- Dynamic Insight Generation Functions ---
        function generateThemesFromData(data) {
            if (currentCsvType !== 'content' || !data || data.length === 0) return [];
            
            const postTextKey = currentCsvHeaders.find(h => normalizeHeader(h) === 'posttext') || currentCsvHeaders.find(h => normalizeHeader(h) === 'text');
            if (!postTextKey) return [];

            let allText = "";
            data.forEach(row => {
                if (row[postTextKey]) allText += row[postTextKey] + " ";
            });

            if (allText.trim() === "") return [];

            const words = allText.toLowerCase().replace(/[^\w\s']|_/g, "").replace(/\s+/g, " ").split(" ");
            const wordCounts = {};

            words.forEach(word => {
                if (word.length > 3 && !STOP_WORDS.has(word) && isNaN(word)) { 
                    wordCounts[word] = (wordCounts[word] || 0) + 1;
                }
            });

            const sortedWords = Object.entries(wordCounts)
                .sort(([,a],[,b]) => b-a)
                .slice(0, 5); 

            return sortedWords.map(([word, count]) => ({ word, count }));
        }

        function generateObservationsFromData(data, csvType, totals, headers) {
            const observations = [];
            if (!data || data.length === 0 || !totals) return ["No data available for observations."];

            if (csvType === 'content') {
                const impressionsKey = headers.find(h => normalizeHeader(h) === 'impressions');
                const engagementsKey = headers.find(h => normalizeHeader(h) === 'engagements');
                const postIdKey = headers.find(h => normalizeHeader(h) === 'postid') || headers.find(h => normalizeHeader(h) === 'id');

                let highestMetric = { name: 'N/A', value: 0 };
                for(const metric of ['Likes', 'Engagements', 'Shares', 'Reposts', 'Replies']) {
                    if (totals[metric] && totals[metric] > highestMetric.value) {
                        highestMetric = { name: metric, value: totals[metric] };
                    }
                }
                if(highestMetric.name !== 'N/A') observations.push(`Content saw high activity in ${highestMetric.name} (${highestMetric.value.toLocaleString()} total).`);

                const totalImpressions = totals['Impressions'] || 0;
                const totalEngagements = totals['Engagements'] || 0;
                if (totalImpressions > 0) {
                    const er = ((totalEngagements / totalImpressions) * 100).toFixed(2);
                    observations.push(`The overall engagement rate was ${er}%.`);
                } else {
                    observations.push(`Engagement rate could not be calculated due to zero impressions.`);
                }
                
                if (engagementsKey && postIdKey) {
                    const topPostByEngagement = findTopPost(data, engagementsKey, headers);
                    if (topPostByEngagement && topPostByEngagement.post) {
                        observations.push(`The top post by Engagements (ID: ${topPostByEngagement.post[postIdKey] || 'N/A'}) garnered ${topPostByEngagement.value.toLocaleString()} engagements.`);
                    }
                }

            } else if (csvType === 'overview') {
                const dateKey = headers.find(h => normalizeHeader(h) === 'date');
                const impressionsKey = headers.find(h => normalizeHeader(h) === 'impressions');
                const engagementsKey = headers.find(h => normalizeHeader(h) === 'engagements');

                const netFollowerGrowth = (totals['New follows'] || 0) - (totals['Unfollows'] || 0);
                observations.push(`Net follower change was ${netFollowerGrowth.toLocaleString()} over this period.`);

                if (impressionsKey && dateKey) {
                    let peakImpressions = { value: -1, date: 'N/A' };
                    data.forEach(row => {
                        const val = parseFloat(String(row[impressionsKey] || '0').replace(/,/g, ''));
                        if (!isNaN(val) && val > peakImpressions.value) {
                            peakImpressions = { value: val, date: row[dateKey] || 'N/A' };
                        }
                    });
                    if (peakImpressions.value > -1) observations.push(`Impressions peaked at ${peakImpressions.value.toLocaleString()} on ${peakImpressions.date}.`);
                }
                 if (engagementsKey && dateKey) {
                    let peakEngagements = { value: -1, date: 'N/A' };
                    data.forEach(row => {
                        const val = parseFloat(String(row[engagementsKey] || '0').replace(/,/g, ''));
                        if (!isNaN(val) && val > peakEngagements.value) {
                            peakEngagements = { value: val, date: row[dateKey] || 'N/A' };
                        }
                    });
                    if (peakEngagements.value > -1) observations.push(`Engagements were highest on ${peakEngagements.date} with ${peakEngagements.value.toLocaleString()}.`);
                }
            }
            return observations.length > 0 ? observations : ["No specific observations generated from the data."];
        }

        function generateDynamicConclusion(themes, observations) {
            if ((!themes || themes.length === 0) && (!observations || observations.length === 0 || observations[0].startsWith("No data"))) {
                return "Insufficient data to draw specific conclusions. Please ensure the uploaded CSV contains relevant information.";
            }
            let conclusionStr = "Based on the uploaded data: ";
            if (themes && themes.length > 0) {
                conclusionStr += `Key content themes appear to revolve around ${themes.map(t => `"${t.word}"`).slice(0,2).join(' and ')}. `;
            } else if (currentCsvType === 'content') {
                conclusionStr += "While specific text themes were not prominent, the content performance metrics provide other insights. "
            }

            if (observations && observations.length > 0 && !observations[0].startsWith("No data")) {
                conclusionStr += observations[0] + " "; 
                if(observations.length > 1) conclusionStr += observations[1] + " ";
            }
            conclusionStr += "Further analysis of these patterns can help refine content strategy for optimal reach and interaction.";
            return conclusionStr;
        }


        function createOverviewMetricCard(label, value, valueColorClass = '') {
            const currentTheme = body.classList.contains('dark-mode') ? 'dark' : 'light';
            const valueBaseColorClass = currentTheme === 'dark' ? 'text-blue-400' : 'text-blue-600';
            return `<div class="metric-card text-center"><div class="metric-value ${valueColorClass || valueBaseColorClass}">${value}</div><div class="metric-label text-muted">${label}</div></div>`;
        }
        
        function findTopPost(data, metricHeaderKey, allHeaders) {
            if (!metricHeaderKey || data.length === 0) return null;
            let topPost = null, maxMetricValue = -Infinity;
            data.forEach(post => {
                 if (post.hasOwnProperty(metricHeaderKey)) { 
                    const metricValue = parseFloat(String(post[metricHeaderKey] || '0').replace(/,/g, ''));
                    if (!isNaN(metricValue) && metricValue > maxMetricValue) {
                        maxMetricValue = metricValue; topPost = post;
                    }
                }
            });
            if (!topPost && data.length > 0 && data[0].hasOwnProperty(metricHeaderKey)) {
                const firstVal = parseFloat(String(data[0][metricHeaderKey] || '0').replace(/,/g, ''));
                return {post: data[0], value: isNaN(firstVal) ? 0 : firstVal};
            } else if (!topPost){ return null; }
            return { post: topPost, value: maxMetricValue };
        }

        function createPostCard(postData, title, metricName, metricValue, allHeaders) {
            const cardWrapper = document.createElement('div'); cardWrapper.className = 'post-card-wrapper'; 
            const cardContentDiv = document.createElement('div'); cardContentDiv.className = 'post-card'; 
            if (!postData || !postData.post) {
                cardContentDiv.innerHTML = `<h4 class="font-semibold text-blue-600 dark:text-blue-400 mb-2">${title}</h4><p class="text-sm text-muted italic">Data for this metric is not available or column not found in CSV.</p>`;
                cardWrapper.appendChild(cardContentDiv); return cardWrapper;
            }
            const { post } = postData;
            const postIdColHeaderKey = allHeaders.find(h => normalizeHeader(h) === normalizeHeader('Post id')) || allHeaders.find(h => normalizeHeader(h) === normalizeHeader('ID'));
            const postTextColHeaderKey = allHeaders.find(h => normalizeHeader(h) === normalizeHeader('Post text')) || allHeaders.find(h => normalizeHeader(h) === normalizeHeader('Text'));
            const impressionsColHeaderKey = allHeaders.find(h => normalizeHeader(h) === normalizeHeader('Impressions'));
            const engagementsColHeaderKey = allHeaders.find(h => normalizeHeader(h) === normalizeHeader('Engagements'));
            const postLinkColHeaderKey = allHeaders.find(h => normalizeHeader(h) === normalizeHeader('Post Link')) || allHeaders.find(h => normalizeHeader(h) === normalizeHeader('Link'));
            let postText = post[postTextColHeaderKey] || 'No text available';
            if (postText.length > 120) postText = postText.substring(0, 120) + '...';
            const displayMetricValue = (isNaN(metricValue) || metricValue === -Infinity) ? 'N/A' : metricValue.toLocaleString();
            const impressionsForContext = post[impressionsColHeaderKey] ? parseFloat(String(post[impressionsColHeaderKey] || '0').replace(/,/g, '')) : 'N/A';
            const engagementsForContext = post[engagementsColHeaderKey] ? parseFloat(String(post[engagementsColHeaderKey] || '0').replace(/,/g, '')) : 'N/A';
            const postUrl = post[postLinkColHeaderKey];
            cardContentDiv.innerHTML = `
                <div class="post-card-content"><p class="text-xs text-muted mb-1">Post ID: ${post[postIdColHeaderKey] || 'N/A'}</p><h4 class="font-semibold text-blue-600 dark:text-blue-400 mb-2">${title}</h4><p class="text-sm mb-3 leading-relaxed">${postText}</p></div>
                <div class="mt-auto"><p class="text-sm font-medium text-purple-600 dark:text-purple-400 mb-1">${metricName}: ${displayMetricValue}</p>
                    ${metricName !== 'Impressions' && impressionsForContext !== 'N/A' ? `<p class="text-xs text-green-600 dark:text-green-400">Impressions: ${impressionsForContext.toLocaleString()}</p>` : ''}
                    ${metricName !== 'Engagements' && engagementsForContext !== 'N/A' ? `<p class="text-xs text-red-500 dark:text-red-400">Engagements: ${engagementsForContext.toLocaleString()}</p>` : ''}</div>`;
            if (postUrl && (String(postUrl).startsWith('http://') || String(postUrl).startsWith('https://'))) {
                const linkElement = document.createElement('a');
                linkElement.href = postUrl; linkElement.target = '_blank'; linkElement.rel = 'noopener noreferrer';
                linkElement.className = 'post-card-link'; linkElement.appendChild(cardContentDiv); 
                cardWrapper.appendChild(linkElement); cardWrapper.style.cursor = 'pointer'; 
            } else {
                cardWrapper.appendChild(cardContentDiv); 
            }
            return cardWrapper;
        }
        
        function populatePostSelectorDropdown(data) {
            postSelectorDropdown.innerHTML = ''; postSelectorDropdown.disabled = data.length === 0;
            if (data.length === 0) {
                postSelectorDropdown.innerHTML = '<option value="">No posts to display</option>';
                individualPostDetailsContainer.innerHTML = '<p class="text-muted placeholder-text">Upload a Content CSV.</p>'; return;
            }
            const defaultOption = document.createElement('option'); defaultOption.value = ""; defaultOption.textContent = "Select a post to view details...";
            postSelectorDropdown.appendChild(defaultOption);
            const headers = currentCsvHeaders;
            const postIdKey = headers.find(h => normalizeHeader(h) === normalizeHeader('Post id')) || headers.find(h => normalizeHeader(h) === normalizeHeader('ID'));
            const postTextKey = headers.find(h => normalizeHeader(h) === normalizeHeader('Post text')) || headers.find(h => normalizeHeader(h) === normalizeHeader('Text'));
            data.forEach((post, index) => {
                const idValue = post[postIdKey]; const textValue = post[postTextKey];
                if ((!idValue || String(idValue).trim() === '') && (!textValue || String(textValue).trim() === '')) return; 
                const option = document.createElement('option'); option.value = index; 
                let displayText = (textValue && String(textValue).trim() !== '') ? `${String(textValue).substring(0, 80)}...` : (idValue && String(idValue).trim() !== '') ? `ID: ${idValue}` : `Unnamed Post (Row ${index + 2})`;
                option.textContent = displayText; postSelectorDropdown.appendChild(option);
            });
            if (postSelectorDropdown.options.length <= 1) { 
                 postSelectorDropdown.options[0].textContent = "No identifiable posts found"; postSelectorDropdown.disabled = true;
            }
            individualPostDetailsContainer.innerHTML = '<p class="text-muted placeholder-text">Select a post to view details.</p>';
        }

        postSelectorDropdown.addEventListener('change', function() { 
            const selectedIndex = this.value;
            individualPostDetailsContainer.innerHTML = ''; 
            const individualPostPngButton = document.querySelector('button[data-section-id="individual-post-analysis"]');
            if(individualPostPngButton) individualPostPngButton.disabled = (selectedIndex === "");

            if (selectedIndex === "" || !parsedCsvData || parsedCsvData.length === 0 || currentCsvType !== 'content') {
                individualPostDetailsContainer.innerHTML = '<p class="text-muted placeholder-text">Select a post to view details.</p>'; return;
            }
            const post = parsedCsvData[parseInt(selectedIndex)];
            if (!post) {
                individualPostDetailsContainer.innerHTML = '<p class="text-red-500 placeholder-text">Error: Could not retrieve post details.</p>'; return;
            }
            const detailsHtml = []; const headers = Object.keys(post);
            const postLinkColHeaderKey = headers.find(h => normalizeHeader(h) === normalizeHeader('Post Link')) || headers.find(h => normalizeHeader(h) === normalizeHeader('Link'));
            headers.forEach(header => {
                let value = post[header]; let displayItem;
                if (header === postLinkColHeaderKey && (String(value).startsWith('http://') || String(value).startsWith('https://'))) {
                    displayItem = `<span class="detail-label">${header}:</span> <a href="${value}" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline">${value}</a>`;
                } else if (normalizeHeader(header) === normalizeHeader('Post text') || normalizeHeader(header) === normalizeHeader('Text')) {
                    displayItem = `<div class="detail-label">${header}:</div><div class="post-text-display">${value || 'N/A'}</div>`;
                } else { displayItem = `<span class="detail-label">${header}:</span> <span>${value || 'N/A'}</span>`; }
                detailsHtml.push(`<div class="detail-item">${displayItem}</div>`);
            });
            individualPostDetailsContainer.innerHTML = detailsHtml.join('');
        });

        function initializeTableSorting(tableElement) {
            if (!tableElement) return;
            const oldThead = tableElement.querySelector('thead'); if (!oldThead) return; 
            const newThead = oldThead.cloneNode(true); oldThead.parentNode.replaceChild(newThead, oldThead); 
            const headersToSort = newThead.querySelectorAll('th[data-sort-col]'); 
            const tbody = tableElement.querySelector('tbody'); if (!tbody) return; 
            headersToSort.forEach(header => {
                header.addEventListener('click', () => { 
                    const columnIndex = parseInt(header.dataset.sortCol);
                    const sortType = header.dataset.sortType || 'string'; 
                    const currentSortOrder = header.dataset.sortOrder || 'asc'; 
                    const newSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                    headersToSort.forEach(h => { 
                        const hIcon = h.querySelector('.sort-icon');
                        if (h !== header && hIcon) { hIcon.innerHTML = ''; delete h.dataset.sortOrder; }
                    });
                    const iconElement = header.querySelector('.sort-icon');
                    if (iconElement) iconElement.innerHTML = newSortOrder === 'asc' ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
                    header.dataset.sortOrder = newSortOrder;
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    if(rows.length > 0 && rows[0].cells.length <= columnIndex) return;
                    rows.sort((rowA, rowB) => {
                        if(rowA.cells.length <= columnIndex || rowB.cells.length <= columnIndex) return 0; 
                        let valA = rowA.cells[columnIndex].textContent.trim();
                        let valB = rowB.cells[columnIndex].textContent.trim();
                        if (valA === '-' || valB === '-') return newSortOrder === 'asc' ? (valA === '-' ? -1 : (valB === '-' ? 1: 0)) : (valA === '-' ? 1 : (valB === '-' ? -1: 0));
                        if (sortType === 'number') {
                            valA = parseFloat(valA.replace(/,/g, '')); valB = parseFloat(valB.replace(/,/g, ''));
                            if (isNaN(valA) && isNaN(valB)) return 0;
                            if (isNaN(valA)) return newSortOrder === 'asc' ? -1 : 1;
                            if (isNaN(valB)) return newSortOrder === 'asc' ? 1 : -1;
                        }
                        let comparison = 0;
                        if (valA > valB) comparison = 1; else if (valA < valB) comparison = -1;
                        return newSortOrder === 'asc' ? comparison : comparison * -1;
                    });
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }
        
        function isValidDate(d) { return d instanceof Date && !isNaN(d); }

        function extractDateRange() {
            if (!parsedCsvData || parsedCsvData.length === 0) return "N/A";
            let dates = [], dateHeader = null;
            const headersToSearch = currentCsvHeaders || Object.keys(parsedCsvData[0] || {});
            if (currentCsvType === 'overview') {
                dateHeader = headersToSearch.find(h => normalizeHeader(h) === 'date');
            } else if (currentCsvType === 'content') {
                const possibleDateHeaders = ['date', 'time', 'timestamp', 'createdat', 'publishedat', 'postdate', 'datecreated', 'postedat'];
                for (const pHeader of possibleDateHeaders) {
                    const foundHeader = headersToSearch.find(h => normalizeHeader(h) === pHeader);
                    if (foundHeader) { dateHeader = foundHeader; break; }
                }
            }
            if (dateHeader) {
                parsedCsvData.forEach(row => {
                    if (row[dateHeader]) {
                        let dateStr = row[dateHeader];
                        if (typeof dateStr === 'string' && dateStr.includes(' +')) dateStr = dateStr.substring(0, dateStr.indexOf(' +')).trim();
                        const d = new Date(dateStr);
                        if (isValidDate(d)) dates.push(d);
                        else {
                            const parts = dateStr.replace(/,/g, '').split(' ');
                            if (parts.length === 3) {
                                const reorderedDateStr = `${parts[1]} ${parts[0]} ${parts[2]}`; 
                                const dAlt = new Date(reorderedDateStr);
                                if (isValidDate(dAlt)) dates.push(dAlt);
                            }
                        }
                    }
                });
            }
            if (dates.length > 0) {
                dates.sort((a, b) => a - b);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return `${dates[0].toLocaleDateString(undefined, options)} to ${dates[dates.length - 1].toLocaleDateString(undefined, options)}`;
            }
            const file = csvFileInput.files.length > 0 ? csvFileInput.files[0].name : "Loaded Data";
            return `Report for ${file}`; 
        }


        // --- HTML Slide Show Functions ---
        function startHtmlSlideShow() {
            if (!parsedCsvData || parsedCsvData.length === 0) {
                uploadStatus.textContent = "Please load data first to view slide show.";
                uploadStatus.style.color = "orange";
                return;
            }
            mainReportContainer.classList.add('hidden-section');
            htmlSlideShowContainer.classList.remove('hidden-section');
            document.body.style.overflow = 'hidden'; 
            buildHtmlSlides();
            currentSlideIndex = 0;
            showHtmlSlide(currentSlideIndex);
        }

        function exitHtmlSlideShow() {
            mainReportContainer.classList.remove('hidden-section');
            htmlSlideShowContainer.classList.add('hidden-section');
            document.body.style.overflow = 'auto'; 
            slideContentArea.innerHTML = ''; 
            htmlSlides = [];
        }

        function showHtmlSlide(index) {
            htmlSlides.forEach((slide, i) => {
                slide.classList.toggle('active', i === index);
            });
            currentSlideIndex = index;
            prevSlideButton.disabled = index === 0;
            nextSlideButton.disabled = index === htmlSlides.length - 1;
            slideIndicator.textContent = `Slide ${index + 1} of ${htmlSlides.length}`;
        }

        function showNextSlide() {
            if (currentSlideIndex < htmlSlides.length - 1) {
                showHtmlSlide(currentSlideIndex + 1);
            }
        }
        function showPrevSlide() {
            if (currentSlideIndex > 0) {
                showHtmlSlide(currentSlideIndex - 1);
            }
        }
        
        function createHtmlSlideEl(title, explainer) {
            const slideEl = document.createElement('div');
            slideEl.className = 'html-slide'; 
            
            const titleEl = document.createElement('h3');
            titleEl.className = 'html-slide-title';
            titleEl.textContent = title;
            slideEl.appendChild(titleEl);

            if (explainer) {
                const explainerEl = document.createElement('p');
                explainerEl.className = 'html-slide-explainer';
                explainerEl.textContent = explainer;
                slideEl.appendChild(explainerEl);
            }
            const contentDiv = document.createElement('div');
            contentDiv.className = 'html-slide-content';
            slideEl.appendChild(contentDiv);
            return { slideEl, contentDiv };
        }

        function buildHtmlSlides() {
            htmlSlides = [];
            slideContentArea.innerHTML = ''; 

            const dateRangeStr = extractDateRange();
            let { slideEl: titleSlideEl, contentDiv: titleContentDiv } = createHtmlSlideEl(`@${currentChannelName} Report`, `Data Period: ${dateRangeStr}`);
            titleContentDiv.innerHTML = `<p class="text-center text-lg">Generated: ${new Date().toLocaleDateString()}</p>`;
            titleContentDiv.style.textAlign = 'center'; 
            htmlSlides.push(titleSlideEl);

            if (currentCsvType === 'content' && metricsTableBodyContent.querySelectorAll('tr').length > 1) {
                let { slideEl, contentDiv } = createHtmlSlideEl("Content Performance Metrics", "This slide summarizes the overall performance of your posts, showing total and average values for key metrics.");
                const tableClone = document.getElementById('metricsTableContent').cloneNode(true);
                contentDiv.appendChild(tableClone);
                htmlSlides.push(slideEl);
            }

            if (currentCsvType === 'content' && engagementRateDisplayContent.textContent !== 'N/A') {
                let { slideEl, contentDiv } = createHtmlSlideEl("Content Engagement Insights", "Highlights the overall engagement rate and lists primary drivers of user interaction.");
                contentDiv.innerHTML = `
                    <p class="text-xl font-semibold mb-4">Overall Engagement Rate: <span class="text-blue-600 dark:text-blue-400">${engagementRateDisplayContent.textContent}</span></p>
                    <h4 class="text-lg font-semibold mb-2">Key Engagement Drivers:</h4>
                    <ul class="list-disc list-inside">${engagementDriversListContent.innerHTML}</ul>`;
                htmlSlides.push(slideEl);
            }
            
            if (currentCsvType === 'content' && topPostsContainerContent.querySelector('.post-card-wrapper')) {
                let { slideEl, contentDiv } = createHtmlSlideEl("Top Performing Posts Highlights", "Showcases your best-performing posts based on various metrics, indicating what resonates most with your audience.");
                const topPostsClone = topPostsContainerContent.cloneNode(true);
                topPostsClone.querySelectorAll('.post-card-wrapper').forEach(wrapper => {
                    wrapper.className = 'mb-4 p-4 border rounded-lg'; 
                });
                topPostsClone.querySelectorAll('.post-card-link').forEach(link => {
                     link.outerHTML = link.innerHTML; 
                });
                 topPostsClone.querySelectorAll('.post-card').forEach(card => {
                    card.classList.remove('transform', 'hover:translate-y-[-5px]', 'hover:shadow-lg'); 
                });
                contentDiv.appendChild(topPostsClone);
                htmlSlides.push(slideEl);
            }

            if (currentCsvType === 'overview' && overviewSummaryCards.querySelector('.metric-card')) {
                 let { slideEl, contentDiv } = createHtmlSlideEl("Account Overview Analytics", "Provides a high-level view of account performance, including key summary metrics. Detailed daily data is available in the main report view.");
                 const summaryCardsClone = overviewSummaryCards.cloneNode(true);
                 summaryCardsClone.querySelectorAll('.metric-card').forEach(card => {
                    card.classList.remove('transform', 'hover:translate-y-[-5px]', 'hover:shadow-lg'); 
                 });
                 contentDiv.appendChild(summaryCardsClone);
                 htmlSlides.push(slideEl);
            }
            
            const dynamicInsightSections = [
                {bodyId: 'contentThemesBody', title: 'Key Content Themes', explainer: "Dominant themes identified from the textual content of your posts."},
                {bodyId: 'keyObservationsBody', title: 'Key Observations & Potential Insights', explainer: "Data-driven observations from the performance metrics."},
                {bodyId: 'conclusionBody', title: 'Conclusion', explainer: "A summary based on the analyzed themes and observations."}
            ];

            dynamicInsightSections.forEach(sectionData => {
                const sectionBodyElement = document.getElementById(sectionData.bodyId);
                if (sectionBodyElement && sectionBodyElement.innerHTML.trim() !== '' && !sectionBodyElement.querySelector('.placeholder-text')) {
                    let { slideEl, contentDiv } = createHtmlSlideEl(sectionData.title, sectionData.explainer);
                    const contentToClone = sectionBodyElement.cloneNode(true);
                    const placeholder = contentToClone.querySelector('.placeholder-text');
                    if(placeholder) placeholder.remove();
                    
                    contentDiv.appendChild(contentToClone);
                    htmlSlides.push(slideEl);
                }
            });


            htmlSlides.forEach(slide => slideContentArea.appendChild(slide));
        }

        // --- PNG Download Functions ---
        function downloadSectionAsPng(sectionId, sectionTitle) {
            const originalSectionElement = document.getElementById(sectionId);
            if (!originalSectionElement) {
                console.error(`Section with ID '${sectionId}' not found for PNG download.`);
                if(uploadStatus) {
                    uploadStatus.textContent = `Error: Could not find section to download.`;
                    uploadStatus.style.color = 'red';
                }
                return;
            }
            if (typeof html2canvas === 'undefined') {
                console.error("html2canvas library is not loaded. Cannot download PNG.");
                 if(uploadStatus) {
                     uploadStatus.textContent = "Error: Image capture library not loaded. Cannot download PNG.";
                     uploadStatus.style.color = 'red';
                 }
                return;
            }

            if(uploadStatus) {
                uploadStatus.textContent = `Generating PNG for ${sectionTitle}...`;
                uploadStatus.style.color = 'inherit';
            }
            
            let elementToCapture;
            let tempParent = null;

            if (sectionId === "individual-post-analysis") {
                const detailsContainer = originalSectionElement.querySelector('#individualPostDetailsContainer');
                if (detailsContainer && detailsContainer.innerHTML.trim() !== '' && !detailsContainer.querySelector('.placeholder-text')) {
                    elementToCapture = detailsContainer.cloneNode(true); 
                } else {
                    if(uploadStatus) {
                        uploadStatus.textContent = `No post details to download for ${sectionTitle}.`;
                        uploadStatus.style.color = 'orange';
                    }
                    return;
                }
            } else {
                let contentBox = null;
                // Find the first direct child that is NOT the title wrapper.
                // This assumes the main content is directly after the title wrapper.
                for (const child of originalSectionElement.children) {
                    if (!child.classList.contains('section-title-wrapper')) {
                        contentBox = child;
                        break;
                    }
                }
                if (contentBox) {
                    elementToCapture = contentBox.cloneNode(true);
                } else {
                    // Fallback: if no distinct content box, clone the whole section and remove title.
                    // This might happen if the section has no title wrapper (e.g., older structure)
                    // or if content is directly in the section.
                    elementToCapture = originalSectionElement.cloneNode(true);
                    const titleWrapperInClone = elementToCapture.querySelector('.section-title-wrapper');
                    if (titleWrapperInClone) {
                        titleWrapperInClone.remove();
                    }
                }
            }
            
            tempParent = document.createElement('div');
            // Apply report section's background to the temp parent if the elementToCapture doesn't have its own
            // and we want to ensure a consistent (but potentially non-transparent) background for the capture.
            // For transparent PNGs, this step for background might not be needed if elementToCapture has its own.
            // The `backgroundColor: null` in html2canvas should handle transparency.
            tempParent.style.padding = originalSectionElement.style.padding || "1.5rem"; // Match padding
            tempParent.style.backgroundColor = window.getComputedStyle(originalSectionElement).backgroundColor;

            tempParent.style.position = 'absolute';
            tempParent.style.left = '-9999px'; 
            tempParent.style.top = '-9999px';
            tempParent.style.width = (originalSectionElement.offsetWidth || 800) + 'px';
            
            // Ensure cloned element also gets theme-specific styling if it relies on parent classes
             if (body.classList.contains('dark-mode')) {
                tempParent.classList.add('dark-mode'); // Apply dark mode to temp parent for context
            } else {
                tempParent.classList.add('light-mode');
            }

            tempParent.appendChild(elementToCapture);
            document.body.appendChild(tempParent);


            html2canvas(elementToCapture, { 
                useCORS: true,
                allowTaint: true,
                backgroundColor: null, // For transparent background
                scrollX: 0,
                scrollY: 0,
                width: elementToCapture.scrollWidth, 
                height: elementToCapture.scrollHeight,
                logging: true 
            }).then(canvas => {
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                const safeChannelName = (currentChannelName || "Report").replace(/[^a-z0-9]/gi, '_').toLowerCase();
                const safeSectionTitle = sectionTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                link.download = `${safeChannelName}_${safeSectionTitle}.png`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                if(uploadStatus){
                    uploadStatus.textContent = `PNG for ${sectionTitle} downloaded.`;
                    uploadStatus.style.color = 'green';
                }
            }).catch(error => {
                console.error(`Error generating PNG for ${sectionId}:`, error);
                if(uploadStatus) {
                    uploadStatus.textContent = `Error generating PNG for ${sectionTitle}. Check console.`;
                    uploadStatus.style.color = 'red';
                }
            }).finally(() => {
                if (tempParent && tempParent.parentElement === document.body) {
                     document.body.removeChild(tempParent);
                }
            });
        }

        function setupPngDownloadButtons() {
            document.querySelectorAll('.download-png-button').forEach(button => {
                button.addEventListener('click', function() {
                    const sectionId = this.dataset.sectionId;
                    const sectionElement = document.getElementById(sectionId);
                    const sectionTitleElement = sectionElement ? sectionElement.querySelector('.section-title-wrapper .section-title') : null;
                    const sectionTitleText = sectionTitleElement ? sectionTitleElement.textContent.trim() : sectionId.replace(/-/g, ' '); 
                    downloadSectionAsPng(sectionId, sectionTitleText);
                });
            });
        }
        
        function enablePngDownloadButtons() {
            document.querySelectorAll('.download-png-button').forEach(button => {
                const sectionId = button.dataset.sectionId;
                if (sectionId === 'individual-post-analysis') {
                    button.disabled = (postSelectorDropdown.value === "" || !individualPostDetailsContainer.innerHTML.trim() || individualPostDetailsContainer.querySelector('.placeholder-text')); 
                } else {
                    const sectionElement = document.getElementById(sectionId);
                    // Enable if the section is visible (not having hidden-section) and its content body does not have placeholder-text
                    const bodyId = sectionId.replace('-dynamic', 'Body'); // e.g. content-themes-dynamic -> contentThemesBody
                    const sectionBodyElement = document.getElementById(bodyId);

                    if(sectionElement && sectionElement.classList.contains('hidden-section')){
                         button.disabled = true;
                    } else if (sectionBodyElement && sectionBodyElement.querySelector('.placeholder-text')) {
                         button.disabled = true;
                    } else if (sectionElement && sectionElement.querySelector('.placeholder-text') && !sectionBodyElement){ // For non-dynamic sections
                         button.disabled = true;
                    }
                    else {
                         button.disabled = false;
                    }
                }
            });
        }

        function disablePngDownloadButtons() {
             document.querySelectorAll('.download-png-button').forEach(button => {
                button.disabled = true;
            });
        }
        
        setupPngDownloadButtons();


        resetUI(); 
        document.getElementById('currentYear').textContent = new Date().getFullYear();
        console.log('Initial UI setup complete.');
    });
    </script>
</body>
</html>
